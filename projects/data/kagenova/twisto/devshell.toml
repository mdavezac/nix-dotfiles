# https://numtide.github.io/devshell
imports = ["service.postgres", "language.c"]

[[commands]]
package = "devshell.cli"
help = "Per project developer environments"

[[commands]]
package = "poetry"

[[commands]]
package = "python38"


[[commands]]
name = "cleandb"
help = "Create clean new test database"
category = "dev helpers"
command = """
    cd $(git rev-parse --show-toplevel)/twisto
    poetry run bash ./clean-db.sh
"""

[[commands]]
name = "mproxy"
help = "Start man-in-the-middle proxy with local certificates"
category = "dev helpers"
command = """
    cd $(git rev-parse --show-toplevel)/service_mocks 
    ./mitmproxy/mitmproxy.sh --ssl-insecure
"""

[[commands]]
name = "openforti"
help = "OpenForti VPN for access to SWETS"
command = """
    sudo openfortivpn -c $(git rev-parse --show-toplevel)/.openfortivpn.cfg
"""

[[commands]]
name = "new_testuser"
help = "Create new test user"
category = "dev helpers"
command = """
    cd $(git rev-parse --show-toplevel)/twisto
    poetry run python manage.py test_user
"""

[[commands]]
name = "runserver"
help = "Start development server"
category = "dev helpers"
command = """
    cd $(git rev-parse --show-toplevel)/twisto
    poetry run python manage.py runserver
"""

[[commands]]
name = "tests"
help = "Run tests"
category = "dev helpers"
command = """
    cd $(git rev-parse --show-toplevel)/twisto
    python manage.py test "$@"
"""

[[commands]]
name = "celery"
help = "Start celery server"
category = "dev helpers"
command = """
    cd $(git rev-parse --show-toplevel)/twisto
    poetry run celery -A twisto -l info worker
"""

[[commands]]
name = "generate_graphql"
help = "regenerate graphql schemas"
category = "dev helpers"
command = """
    cd $(git rev-parse --show-toplevel)/twisto
    python3 manage.py graphql_sdl --out ./gql_schemas/schema.graphql
"""

[devshell]
packages = [
    "pkgconfig",
    "file",
    "gdal",
    "cairo",
    "black",
    "redis",
    "elasticsearch7",
    "elasticsearchPlugins.analysis-icu",
]

[service.postgres]
package = "mypostgresql"

[language.c]
includes = ["graphviz", "geos"]
libraries = ["glib.out", "pango", "fontconfig", "openssl.out"]

[[env]]
name = "DYLD_FALLBACK_LIBRARY_PATH"
prefix = "$DEVSHELL_DIR/lib"

[[env]]
name = "LDFLAGS"
eval = "-L$DEVSHELL_DIR/lib"

[[env]]
name = "PGUSER"
eval = "$USER"

[[env]]
name = "EDITOR"
value = "nvim"

[[env]]
name = "NVIM_LISTEN_ADDRESS"
eval = "${PRJ_DATA_DIR}/nvim.rpc"

[[env]]
name = "FONTCONFIG_PATH"
value = "/Users/mdavezac/.config/fontconfig"
